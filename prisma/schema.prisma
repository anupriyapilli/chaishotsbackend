generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  EDITOR
  VIEWER
}

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String
  role         Role     @default(EDITOR)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  userRoles    UserRole[]   // <â€” add this line
}


model Order {
  id        String   @id @default(uuid())
  customer  String
  status    String
  amount    Int
  createdAt DateTime @default(now())
}
// ---------- Domain enums ----------

enum ProgramStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum ContentType {
  VIDEO
  ARTICLE
}

enum LessonStatus {
  DRAFT
  SCHEDULED
  PUBLISHED
  ARCHIVED
}

enum AssetVariant {
  PORTRAIT
  LANDSCAPE
  SQUARE
  BANNER
}

enum ProgramAssetType {
  POSTER
}

enum LessonAssetType {
  THUMBNAIL
  SUBTITLE
}

// ---------- RBAC join models ----------

model AppRole {
  id        Int       @id @default(autoincrement())
  name      String    @unique   // 'ADMIN' | 'EDITOR' | 'VIEWER'
  userRoles UserRole[]
}

model UserRole {
  userId String
  roleId Int

  user User    @relation(fields: [userId], references: [id])
  role AppRole @relation(fields: [roleId], references: [id])

  @@id([userId, roleId])
}

// ---------- Program / Topic / Term / Lesson ----------

model Program {
  id                 String         @id @default(uuid())
  title              String
  description        String?
  languagePrimary    String
  languagesAvailable String[]
  status             ProgramStatus  @default(DRAFT)
  publishedAt        DateTime?
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt

  terms         Term[]
  programTopics ProgramTopic[]
  assets        ProgramAsset[]

  @@index([status, languagePrimary, publishedAt])
}

model Topic {
  id    String @id @default(uuid())
  name  String @unique

  programTopics ProgramTopic[]
}

model ProgramTopic {
  programId String
  topicId   String

  program Program @relation(fields: [programId], references: [id])
  topic   Topic   @relation(fields: [topicId], references: [id])

  @@id([programId, topicId])
  @@index([programId])
  @@index([topicId])
}

model Term {
  id         String   @id @default(uuid())
  programId  String
  termNumber Int
  title      String?
  createdAt  DateTime @default(now())

  program Program @relation(fields: [programId], references: [id])
  lessons Lesson[]

  @@unique([programId, termNumber])
  @@index([programId])
}

model Lesson {
  id                        String       @id @default(uuid())
  termId                    String
  lessonNumber              Int
  title                     String
  contentType               ContentType
  durationMs                Int?
  isPaid                    Boolean      @default(false)

  contentLanguagePrimary    String
  contentLanguagesAvailable String[]
  contentUrlsByLanguage     Json

  subtitleLanguages         String[]
  subtitleUrlsByLanguage    Json?

  status       LessonStatus @default(DRAFT)
  publishAt    DateTime?
  publishedAt  DateTime?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  term   Term          @relation(fields: [termId], references: [id])
  assets LessonAsset[]

  @@unique([termId, lessonNumber])
  @@index([status, publishAt])
  @@index([termId, lessonNumber])
}

// ---------- Assets ----------

model ProgramAsset {
  id        String          @id @default(uuid())
  programId String
  language  String
  variant   AssetVariant
  assetType ProgramAssetType
  url       String

  program Program @relation(fields: [programId], references: [id])

  @@unique([programId, language, variant, assetType])
  @@index([programId, language])
}

model LessonAsset {
  id        String        @id @default(uuid())
  lessonId  String
  language  String
  variant   AssetVariant
  assetType LessonAssetType
  url       String

  lesson Lesson @relation(fields: [lessonId], references: [id])

  @@unique([lessonId, language, variant, assetType])
  @@index([lessonId, language])
}
